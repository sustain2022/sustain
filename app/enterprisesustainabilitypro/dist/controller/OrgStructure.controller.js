sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/core/mvc/Controller","sap/suite/ui/commons/networkgraph/layout/LayeredLayout","sap/suite/ui/commons/networkgraph/layout/ForceBasedLayout","sap/suite/ui/commons/networkgraph/ActionButton","sap/suite/ui/commons/networkgraph/Node","sap/ui/core/Fragment"],function(e,t,i,o,s,a,n){"use strict";var r="EID0001";return t.extend("enterprisesustainabilitypro.controller.OrgStructure",{onInit:function(){this._oModel=new e(this.getOwnerComponent().getModel("orgChart").getData());this._oModel.setDefaultBindingMode(sap.ui.model.BindingMode.OneWay);this._sTopSupervisor=r;this._mExplored=[this._sTopSupervisor];this._graph=this.byId("graph");this.getView().setModel(this._oModel);this._setFilter();this._graph.attachEvent("beforeLayouting",function(e){this._graph.preventInvalidation(true);this._graph.getNodes().forEach(function(e){var t,i,o,a=this._getCustomDataValue(e,"team"),n;e.removeAllActionButtons();if(!a){e.setShowExpandButton(false)}else{if(this._mExplored.indexOf(e.getKey())===-1){e.setShowExpandButton(false);e.setCollapsed(true);t=new s({title:"Expand",icon:"sap-icon://sys-add",press:function(){e.setCollapsed(false);this._loadMore(e.getKey())}.bind(this)});e.addActionButton(t)}else{e.setShowExpandButton(true)}}i=new s({title:"Detail",icon:"sap-icon://person-placeholder",press:function(t){this._openDetail(e,t.getParameter("buttonElement"))}.bind(this)});e.addActionButton(i);if(e.getKey()===this._sTopSupervisor){n=this._getCustomDataValue(e,"supervisor");if(n){o=new s({title:"Up one level",icon:"sap-icon://arrow-top",press:function(){var t=e.getCustomData().filter(function(e){return e.getKey()==="supervisor"}),i=t.length>0&&t[0].getValue();this._loadMore(i);this._sTopSupervisor=i}.bind(this)});e.addActionButton(o)}}},this);this._graph.preventInvalidation(false)}.bind(this))},search:function(e){var t=e.getParameter("key");if(t){this._mExplored=[t];this._sTopSupervisor=t;this._graph.destroyAllElements();this._setFilter();e.bPreventDefault=true}},suggest:function(e){var t=[],i=this._oModel.getData().nodes,o=[],s=e.getParameter("term");s=s?s:"";o=i.filter(function(e){var t=e.EmployeeName?e.EmployeeName:"";return t.toLowerCase().indexOf(s.toLowerCase())!==-1});o.sort(function(e,t){var i=e.title?e.title:"";return i.localeCompare(t.title)}).forEach(function(e){t.push(new sap.m.SuggestionItem({key:e.EmployeeID,text:e.EmployeeName}))});this._graph.setSearchSuggestionItems(t);e.bPreventDefault=true},onExit:function(){if(this._oQuickView){this._oQuickView.destroy()}},_setFilter:function(){var e=[],t=[];var i=function(t){e.push(new sap.ui.model.Filter({path:"EmployeeID",operator:sap.ui.model.FilterOperator.EQ,value1:t}));e.push(new sap.ui.model.Filter({path:"Supervisor",operator:sap.ui.model.FilterOperator.EQ,value1:t}))};var o=function(e){t.push(new sap.ui.model.Filter({path:"supervisor",operator:sap.ui.model.FilterOperator.EQ,value1:e}))};this._mExplored.forEach(function(e){i(e);o(e)});this._graph.getBinding("nodes").filter(new sap.ui.model.Filter({filters:e,and:false}));this._graph.getBinding("lines").filter(new sap.ui.model.Filter({filters:t,and:false}))},_loadMore:function(e){this._graph.deselect();this._mExplored.push(e);this._graph.destroyAllElements();this._setFilter()},_getCustomDataValue:function(e,t){var i=e.getCustomData().filter(function(e){return e.getKey()===t});return i.length>0&&i[0].getValue()},_openDetail:function(t,i){var o=this._getCustomDataValue(t,"team");if(!this._oQuickView){n.load({name:"enterprisesustainabilitypro.fragments.TooltipFragment",type:"XML"}).then(function(o){this._oQuickView=o;this._oQuickView.setModel(new e({icon:t.getImage()&&t.getImage().getProperty("src"),EmployeeName:t.getDescription(),Position:this._getCustomDataValue(t,"Position"),CountryID:this._getCustomDataValue(t,"CountryID"),TeamMembers:this._getCustomDataValue(t,"TeamMembers"),GoalsAssigned:this._getCustomDataValue(t,"GoalsAssigned"),TeamGoals:this._getCustomDataValue(t,"TeamGoals"),Email:this._getCustomDataValue(t,"Email"),ContactNumber:this._getCustomDataValue(t,"ContactNumber")}));setTimeout(function(){this._oQuickView.openBy(i)}.bind(this),0)}.bind(this))}else{this._oQuickView.setModel(new e({icon:t.getImage()&&t.getImage().getProperty("src"),EmployeeName:t.getDescription(),Position:this._getCustomDataValue(t,"Position"),CountryID:this._getCustomDataValue(t,"CountryID"),TeamMembers:this._getCustomDataValue(t,"TeamMembers"),GoalsAssigned:this._getCustomDataValue(t,"GoalsAssigned"),TeamGoals:this._getCustomDataValue(t,"TeamGoals"),Email:this._getCustomDataValue(t,"Email"),ContactNumber:this._getCustomDataValue(t,"ContactNumber")}));setTimeout(function(){this._oQuickView.openBy(i)}.bind(this),0)}},linePress:function(e){e.bPreventDefault=true}})});