sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/export/library","sap/ui/export/Spreadsheet","sap/ui/table/Table","sap/ui/comp/smarttable/SmartTable","../utils/util"],function(e,t,a,i,s,l){"use strict";var n=t.EdmType;return e.extend("sustainabilitypro.controller.Reports",{onInit:function(){if(localStorage.getItem("user")){this.getOwnerComponent()._clientId=localStorage.getItem("user")}this.getOwnerComponent().getRouter().getRoute("reports").attachPatternMatched(this._onRouteMatched,this);this.getOwnerComponent().getModel().read("/AgencyReportTemplate",{urlParameters:{$expand:"AgencyReportTemplateDetails"},filters:[new sap.ui.model.Filter({path:"ClientID",operator:"EQ",value1:this.getOwnerComponent()._clientId})],success:function(e){this._templates=e.results;for(var t in this._templates){if(this._templates[t].TemplateType=="Internal"){this.setReportTable(this._templates[t].TemplateID,"Internal",this._templates[t].TemplateDescription)}else{this.setReportTable(this._templates[t].TemplateID,"External",this._templates[t].TemplateDescription)}}}.bind(this)});this._setReports=true},_onRouteMatched:function(){if(this._templates&&this._setReports){this.byId("panelIntReports").destroyContent();this.byId("panelExtReports").destroyContent();for(var e in this._templates){if(this._templates[e].TemplateType=="Internal"){this.setReportTable(this._templates[e].TemplateID,"Internal",this._templates[e].TemplateDescription)}else{this.setReportTable(this._templates[e].TemplateID,"External",this._templates[e].TemplateDescription)}}this._setReports=false}},setReportTable:function(e,t,a){var i=new sap.m.Panel({headerText:a,expandable:true}).addStyleClass("sapUiResponsiveMargin");var l=this._getInitiallyVisibleFields(e);var n=new s({entitySet:"AgencyReport",tableType:"Table",useExportToExcel:true,header:"Line Items",showRowCount:true,showFullScreenButton:true,enableAutoBinding:true,enableAutoColumnWidth:true,ignoredFields:l.ignoredFlds,initiallyVisibleFields:l.initialCol,beforeRebindTable:this.onBeforeRebindTable.bind(this),initialise:this.onInitialise.bind(this)}).addStyleClass("sapUiResponsiveContentPadding").addCustomData(new sap.ui.core.CustomData({key:e,value:e}));if(t==="Internal"){this.byId("panelIntReports").addContent(i.addContent(n))}else{this.byId("panelExtReports").addContent(i.addContent(n))}},onBeforeRebindTable:function(e){var t=e.getSource().getCustomData()[0].getKey();var a=e.getParameter("bindingParams");var i=new sap.ui.model.Filter("TemplateID","EQ",t);a.filters.push(i);var s=e.getSource().getTable();this._setColumnHeaders(t,s.getColumns());s.setSelectionMode("None")},onInitialise:function(e){e.getSource().getTable().attachRowsUpdated(this._resizeColumns.bind(this))},_resizeColumns:function(e){var t=e.getSource();var a=t.getColumns().length;for(let e=a-1;e>=0;e--){t.autoResizeColumn(e)}},_setColumnHeaders:function(e,t){var a=this._templates.map(function(e){return e.TemplateID}).indexOf(e);var i=this._templates[a].AgencyReportTemplateDetails.results;for(var s in t){if(t[s].getLabel().getText()!=="ExportID"&&t[s].getLabel().getText()!=="CreatedAt"){t[s].getLabel().setText(i[s].FieldName)}}},_getInitiallyVisibleFields:function(e){var t=this._templates.map(function(e){return e.TemplateID}).indexOf(e);var a=this._templates[t].AgencyReportTemplateDetails.results;let i="";let s="Column0,RecordNumber,SerialNo,TemplateID,";for(let e=1;e<=70;e++){if(e<=a.length){i=i+"Column"+e+","}else{s=s+"Column"+e+","}}i=i+"ExportID,CreatedAt";return{initialCol:i,ignoredFlds:s.slice(0,-1)}},createColumnConfig:function(){var e=[],t=0;var a=this._oTable.getColumns();for(var i in a){t=t+1;e.push({label:a[i].getLabel().getText(),property:"Column"+t})}return e},onExport:function(){var e,t,i,s,l;if(!this._oTable){this._oTable=this.byId("Report")}l=this._oTable;t=l.getBinding("rows");e=this.createColumnConfig();i={workbook:{columns:e,hierarchyLevel:"Level"},dataSource:t,fileName:"Table export sample.xlsx",worker:false};s=new a(i);s.build().finally(function(){s.destroy()})},onUploadRequest:function(e){if(!this.uploadDialog){this.uploadDialog=this.loadFragment({name:"sustainabilitypro.fragments.UploadReports"}).then(function(e){this.uploadDialog=e;l.clientFilter(this,"idSelectTemplate","items");e.open()}.bind(this))}else{l.clientFilter(this,"idSelectTemplate","items");this.uploadDialog.open()}},onUploadReport:function(){var e=this.byId("idSelectTemplate").getSelectedKey();if(e==""&&this.byId("rbgUpload").getSelectedIndex()==0){this.byId("idSelectTemplate").setValueState("Error");return}if(this.byId("rbgUpload").getSelectedIndex()==1){this.createTemplate()}else{var t=this.byId("dataStartingRow").getValue();var a=this._templates.map(function(e){return e.TemplateID}).indexOf(e);var i=this._templates[a].AgencyReportTemplateDetails.results;var s=this.getOwnerComponent().getModel();s.setUseBatch(true);s.setDeferredGroups(["foo"]);var l={groupId:"foo",success:function(e,t){sap.m.MessageToast.show("Uploaded");this._setReports=true;this._onRouteMatched()}.bind(this),error:function(){}};for(var n in this._excelData){if(n<t){continue}var o={TemplateID:e,ClientID:this.getOwnerComponent()._clientId};var r=[];for(var p in i){var d={TemplateID:e,ClientID:this.getOwnerComponent()._clientId,FieldID:i[p].FieldID,FieldValue:this._excelData[n][i[p].FieldSRN-1]?this._excelData[n][i[p].FieldSRN-1].toString():" "};r.push(d)}o.AgencyReportDetails=r;s.create("/AgencyReportHeader",o,l)}s.submitChanges(l)}this.uploadDialog.close()},onCloseUploadDlg:function(){this.byId("fileUploader").clear();this.uploadDialog.close()},onUpload:function(e){this._import(e.getParameter("files")&&e.getParameter("files")[0])},_import:function(e){var t=this;var a={};if(e&&window.FileReader){var i=new FileReader;i.onload=function(e){var i=e.target.result;var s=XLSX.read(i,{type:"binary"});s.SheetNames.forEach(function(e){a=XLSX.utils.sheet_to_row_object_array(s.Sheets[e],{header:1})});t._excelData=a};i.onerror=function(e){console.log(e)};i.readAsBinaryString(e)}},createTemplate:function(){var e=[];var t=this.getOwnerComponent().getModel();var a=this.getOwnerComponent().getModel("goals");t.setUseBatch(true);t.setDeferredGroups(["foo"]);var i={groupId:"foo",success:function(e,t){this.getOwnerComponent().getModel().read("/AgencyReportTemplate",{urlParameters:{$expand:"AgencyReportTemplateDetails"},filters:[new sap.ui.model.Filter({path:"ClientID",operator:"EQ",value1:this.getOwnerComponent()._clientId})],success:function(e){this._templates=e.results}.bind(this)});sap.m.MessageToast.show("Template Created")}.bind(this),error:function(e,t){sap.m.MessageToast.show("Template Creation Failed")}.bind(this)};var s={ClientID:this.getOwnerComponent()._clientId,TemplateName:this.byId("templateName").getValue(),TemplateType:this.byId("idSelectTemplateType").getSelectedKey(),TemplateDescription:this.byId("templateName").getValue()};var l=this._excelData[0];for(var n in l){var o={ClientID:this.getOwnerComponent()._clientId,FieldID:parseInt(n)+1,FieldSRN:parseInt(n)+1,FieldName:l[n],FieldDescription:l[n]};e.push(o)}s.AgencyReportTemplateDetails=e;t.create("/AgencyReportTemplate",s,i);t.submitChanges(i)},onSelectingRBG:function(e){if(e.getParameter("selectedIndex")===0){this.byId("idSelectTemplate").setVisible(true);this.byId("idSelectTemplateType").setVisible(false);this.byId("dataStartingRow").setVisible(true);this.byId("templateName").setVisible(false)}else{this.byId("idSelectTemplate").setVisible(false);this.byId("idSelectTemplateType").setVisible(true);this.byId("dataStartingRow").setVisible(false);this.byId("templateName").setVisible(true)}this.byId("fileUploader").clear()},onTemplateSelection:function(e){e.getSource().setValueState("None")}})});