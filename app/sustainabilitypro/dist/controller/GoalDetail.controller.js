sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/DatePicker","sap/m/Input","sap/m/Text","sap/ui/core/routing/History","../utils/util"],function(e,t,a,o,n,l,i,s,r){"use strict";return e.extend("sustainabilitypro.controller.GoalDetail",{onInit:function(){if(localStorage.getItem("user")){this.getOwnerComponent()._clientId=localStorage.getItem("user")}this.getOwnerComponent().getRouter().getRoute("goaldet").attachPatternMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){var t=e.getParameter("arguments").path.split(";");this._GoalID=t[2];var a="/GoalHeader(GoalTemplateID='"+t[0]+"',ClientID='"+t[1]+"',GoalID="+t[2]+")";this.byId("ObjectPageLayout").getHeaderTitle().bindContext(a);this.byId("ObjectPageLayout").getHeaderContent()[0].bindContext(a);if(!this._GoalDet){this.loadFragment({name:"sustainabilitypro.fragments.GoalDetDisplay"}).then(function(e){this._GoalDet=e;this.byId("GoalDet").addBlock(e);this._generateGoalFields(a)}.bind(this))}else{this._generateGoalFields(a)}this._filterTablesWithGoalID(t[2])},_generateGoalFields:function(e){var t=this.getView().byId("GoalDetDisplay");t.getFormContainers()[0].bindAggregation("formElements",{path:e+"/GoalDetails",parameters:{expand:"GoalFields"},template:new sap.ui.layout.form.FormElement({label:"{GoalFields/FieldName}",fields:[new i({text:"{FieldValue}"})]}),events:{change:this._onBindingChange.bind(this),dataRequested:function(e){t.setBusy(true)},dataReceived:function(e){t.setBusy(false)}}})},_onBindingChange:function(e){},_generateFields:function(e){var t=this.byId("FormGoal").getFormContainers()[0];t.destroyFormElements();e.sort(function(e,t){return e.FieldSRN-t.FieldSRN});for(var a in e){if(e[a].FieldSRN%2==1){t.addFormElement(new FormElement({label:e[a].FieldName,fields:[r.getEditField(e[a])]}))}}for(var a in e){if(e[a].FieldSRN%2==0){t.addFormElement(new FormElement({label:e[a].FieldName,fields:[r.getEditField(e[a])]}))}}},_filterTablesWithGoalID:function(e){this.byId("dptGoalTbl").getBinding("items").filter([new a("GoalID","EQ",e)]);this.byId("empGoalTbl").getBinding("items").filter([new a("GoalID","EQ",e)]);this.byId("empUpdGoalTbl").getBinding("items").filter([new a("GoalID","EQ",e)]);this.byId("supGoalTbl").getBinding("items").filter([new a("GoalID","EQ",e)]);this.byId("supUpdGoalTbl").getBinding("items").filter([new a("GoalID","EQ",e)])},onValueHelpDeptsRequested:function(){if(!this._oValueHelpDialogForDepts){t.load({name:"sustainabilitypro.fragments.Departments",controller:this}).then(function e(t){this._oValueHelpDialogForDepts=t;this.getView().addDependent(this._oValueHelpDialogForDepts);t.removeButton(0);t.removeButton(0);this._oValueHelpDialogForDepts.getTableAsync().then(function(e){if(e.bindRows){e.bindRows({path:"/DepartmentHeader",filters:[new a("ClientID","EQ",this.getOwnerComponent()._clientId)]});this._addDeptColumns(e)}if(e.bindItems){e.bindAggregation("items","/DepartmentHeader",function(){return new sap.m.ColumnListItem({cells:[new i({text:"{DepartmentID}"})]})})}this._oValueHelpDialogForDepts.update()}.bind(this));this._oValueHelpDialogForDepts.open()}.bind(this))}else{this._oValueHelpDialogForDepts.open()}},onValueHelpEmpRequested:function(){if(!this._oValueHelpDialogForEmp){t.load({name:"sustainabilitypro.fragments.EmployeeGoal",controller:this}).then(function e(t){this._oValueHelpDialogForEmp=t;this.getView().addDependent(this._oValueHelpDialogForEmp);t.removeButton(0);t.removeButton(0);this._oValueHelpDialogForEmp.getTableAsync().then(function(e){if(e.bindRows){e.bindRows({path:"/EmployeeUser",filters:[new a("ClientID","EQ",this.getOwnerComponent()._clientId)]});this._addEmpColumns(e)}if(e.bindItems){e.bindAggregation("items","/EmployeeUser",function(){return new sap.m.ColumnListItem({cells:[new i({text:"{EmployeeID}"})]})})}this._oValueHelpDialogForEmp.update()}.bind(this));this._oValueHelpDialogForEmp.open()}.bind(this))}else{this._oValueHelpDialogForEmp.open()}},onValueHelpSupRequested:function(){if(!this._oValueHelpDialogForSup){t.load({name:"sustainabilitypro.fragments.SupplierGoal",controller:this}).then(function e(t){this._oValueHelpDialogForSup=t;this.getView().addDependent(this._oValueHelpDialogForSup);t.removeButton(0);t.removeButton(0);this._oValueHelpDialogForSup.getTableAsync().then(function(e){if(e.bindRows){e.bindRows({path:"/SupplierHeader",filters:[new a("ClientID","EQ",this.getOwnerComponent()._clientId)]});this._addSupColumns(e)}if(e.bindItems){e.bindAggregation("items","/SupplierHeader",function(){return new sap.m.ColumnListItem({cells:[new i({text:"{SupplierID}"})]})})}this._oValueHelpDialogForSup.update()}.bind(this));this._oValueHelpDialogForSup.open()}.bind(this))}else{this._oValueHelpDialogForSup.open()}},_addDeptColumns:function(e){e.addColumn(new sap.ui.table.Column({label:"Department Name",template:new i({text:"{DepartmentName}"})}));e.addColumn(new sap.ui.table.Column({label:"HOD",template:new i({text:"{HOD}"})}));e.addColumn(new sap.ui.table.Column({label:"Department Type",template:new i({text:"{DepartmentType}"})}));e.addColumn(new sap.ui.table.Column({label:"Begin Date",template:new n}));e.addColumn(new sap.ui.table.Column({label:"End Date",template:new n}));e.addColumn(new sap.ui.table.Column({label:"Target Assigned",template:new l}))},_addEmpColumns:function(e){e.addColumn(new sap.ui.table.Column({label:"User ID",template:new i({text:"{UserID}"})}));e.addColumn(new sap.ui.table.Column({label:"Employee Name",template:new i({text:"{EmployeeName}"})}));e.addColumn(new sap.ui.table.Column({label:"Begin Date",template:new n}));e.addColumn(new sap.ui.table.Column({label:"End Date",template:new n}));e.addColumn(new sap.ui.table.Column({label:"Target Assigned",template:new l}))},_addSupColumns:function(e){e.addColumn(new sap.ui.table.Column({label:"Supplier Name",template:new i({text:"{SupplierName}"})}));e.addColumn(new sap.ui.table.Column({label:"Contact Name",template:new i({text:"{ContactName}"})}));e.addColumn(new sap.ui.table.Column({label:"Begin Date",template:new n}));e.addColumn(new sap.ui.table.Column({label:"End Date",template:new n}));e.addColumn(new sap.ui.table.Column({label:"Target Assigned",template:new l}))},onFilterBarSearch:function(e){var t=e.getSource().getFilters();var o;switch(e.getSource().getEntitySet()){case"DepartmentHeader":o=this._oValueHelpDialogForDepts;break;case"EmployeeGoal":o=this._oValueHelpDialogForEmp;break;case"SupplierHeader":o=this._oValueHelpDialogForSup;break;default:break}this._filterTable(new a({filters:t,and:true}),o)},_filterTable:function(e,t){var a=t;a.getTableAsync().then(function(t){if(t.bindRows){t.getBinding("rows").filter(e)}if(t.bindItems){t.getBinding("items").filter(e)}a.update()})},onDepartmentAssign:function(e){var t=this.getOwnerComponent().getModel();t.setUseBatch(true);t.setDeferredGroups(["foo"]);var a={groupId:"foo",success:function(e,t){sap.m.MessageToast.show("Assignment Done")},error:function(e,t){sap.m.MessageToast.show("Assignment Failed")}};var o={};var n=e.getSource().getParent().getTable().getRows();var l=e.getSource().getParent().getTable().getSelectedIndices();var i,s;for(var r in l){i=n[l[r]].getBindingContext().getPath();s=e.getSource().getModel().getProperty(i);o={ClientID:this.getOwnerComponent()._clientId,GoalID:this._GoalID,DepartmentID:s.DepartmentID,BeginDate:n[l[r]].getCells()[3].getDateValue(),EndDate:n[l[r]].getCells()[4].getDateValue(),TargetAssigned:parseInt(n[l[r]].getCells()[5].getValue())};t.create("/DepartmentGoal",o,a)}t.submitChanges(a);this._oValueHelpDialogForDepts.close()},onEmployeeAssign:function(e){var t=this.getOwnerComponent().getModel();t.setUseBatch(true);t.setDeferredGroups(["foo"]);var a={groupId:"foo",success:function(e,t){sap.m.MessageToast.show("Assignment Done")},error:function(e,t){sap.m.MessageToast.show("Assignment Failed")}};var o={};var n=e.getSource().getParent().getTable().getRows();var l=e.getSource().getParent().getTable().getSelectedIndices();var i,s;for(var r in l){i=n[l[r]].getBindingContext().getPath();s=e.getSource().getModel().getProperty(i);o={ClientID:this.getOwnerComponent()._clientId,GoalID:this._GoalID,EmployeeID:s.EmployeeID,BeginDate:n[l[r]].getCells()[2].getDateValue(),EndDate:n[l[r]].getCells()[3].getDateValue(),TargetAssigned:parseInt(n[l[r]].getCells()[4].getValue())};t.create("/EmployeeGoal",o,a)}t.submitChanges(a);this._oValueHelpDialogForEmp.close()},onSupplierAssign:function(e){var t=this.getOwnerComponent().getModel();t.setUseBatch(true);t.setDeferredGroups(["foo"]);var a={groupId:"foo",success:function(e,t){sap.m.MessageToast.show("Assignment Done")},error:function(e,t){sap.m.MessageToast.show("Assignment Failed")}};var o={};var n=e.getSource().getParent().getTable().getRows();var l=e.getSource().getParent().getTable().getSelectedIndices();var i,s;for(var r in l){i=n[l[r]].getBindingContext().getPath();s=e.getSource().getModel().getProperty(i);o={ClientID:this.getOwnerComponent()._clientId,GoalID:this._GoalID,SupplierID:s.SupplierID,BeginDate:n[l[r]].getCells()[2].getDateValue(),EndDate:n[l[r]].getCells()[3].getDateValue(),TargetAssigned:parseInt(n[l[r]].getCells()[4].getValue())};t.create("/SupplierGoal",o,a)}t.submitChanges(a);this._oValueHelpDialogForSup.close()},onDepartmentDialogClose:function(){this._oValueHelpDialogForDepts.close()},onEmployeeDialogClose:function(){this._oValueHelpDialogForEmp.close()},onSupplierDialogClose:function(){this._oValueHelpDialogForSup.close()},onEmpAddUpdRequest:function(e){if(!this.empGoalUpdDialog){this.empGoalUpdDialog=this.loadFragment({name:"sustainabilitypro.fragments.EmployeeGoalUpdate"}).then(function(e){this.empGoalUpdDialog=e;e.open()}.bind(this))}else{this.empGoalUpdDialog.open()}},onSupAddUpdRequest:function(e){if(!this.supGoalUpdDialog){this.supGoalUpdDialog=this.loadFragment({name:"sustainabilitypro.fragments.SupplierGoalUpdate"}).then(function(e){this.supGoalUpdDialog=e;e.open()}.bind(this))}else{this.supGoalUpdDialog.open()}},onEmpUpdSave:function(e){var t=this.getOwnerComponent().getModel();t.setUseBatch(true);t.setDeferredGroups(["foo"]);var a={groupId:"foo",success:function(e,t){sap.m.MessageToast.show("Target Updated")},error:function(e,t){sap.m.MessageToast.show("Target Update Failed")}};var o={ClientID:this.getOwnerComponent()._clientId};var n=this.byId("addEmpGoalUpdateForm").getFormContainers()[0].getFormElements();var l=n[0].getFields()[0].getSelectedKey();var i=this.byId("empGoalTbl").getItems();for(var s in i){if(i[s].getCells()[7].getText()==l){o.AssignmentID=i[s].getCells()[8].getText();o.Status_Biz=i[s].getCells()[6].getText();break}}o.GoalID=this._GoalID;o.EmployeeID=l;o.TargetAssigned=parseInt(n[0].getFields()[0].getSelectedItem().getCustomData()[0].getValue());o.TargetAchieved=parseInt(n[1].getFields()[0].getValue());o.AdditionalInfo=n[2].getFields()[0].getValue();t.create("/EmployeeGoalUpdate",o,a);t.submitChanges(a);this.empGoalUpdDialog.close()},onSupUpdSave:function(e){var t=this.getOwnerComponent().getModel();t.setUseBatch(true);t.setDeferredGroups(["foo"]);var a={groupId:"foo",success:function(e,t){sap.m.MessageToast.show("Target Updated")},error:function(e,t){sap.m.MessageToast.show("Target Update Failed")}};var o={ClientID:this.getOwnerComponent()._clientId};var n=this.byId("addSupGoalUpdateForm").getFormContainers()[0].getFormElements();var l=n[0].getFields()[0].getSelectedKey();var i=this.byId("supGoalTbl").getItems();for(var s in i){if(i[s].getCells()[7].getText()==l){o.AssignmentID=i[s].getCells()[8].getText();o.Status_Biz=i[s].getCells()[6].getText();break}}o.GoalID=this._GoalID;o.SupplierID=l;o.EmployeeID=n[1].getFields()[0].getSelectedKey();o.TargetAssigned=parseInt(n[0].getFields()[0].getSelectedItem().getCustomData()[0].getValue());o.TargetAchieved=parseInt(n[2].getFields()[0].getValue());o.AdditionalInfo=n[3].getFields()[0].getValue();t.create("/SupplierGoalUpdate",o,a);t.submitChanges(a);this.supGoalUpdDialog.close()},onCloseAddEmpUpdDlg:function(e){e.getSource().getParent().close()},onCloseAddSupUpdDlg:function(e){e.getSource().getParent().close()},onNavback:function(){this.getView().getParent().getParent().setMode("ShowHideMode");var e=s.getInstance();var t=e.getPreviousHash();if(t!==undefined){window.history.go(-1)}else{var a=this.getOwnerComponent().getRouter();a.navTo("detailsd1",{},true)}}})});