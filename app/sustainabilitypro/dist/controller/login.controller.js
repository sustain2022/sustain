sap.ui.define(["sustainabilitypro/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","sap/ui/model/Filter","sustainabilitypro/controller/oDataHelper"],function(e,t,s,o,i){"use strict";return e.extend("susproapp.controller.login",{onInit:function(){this._oModel=this.getModel();if(localStorage.getItem("user")){this.getOwnerComponent()._clientId=localStorage.getItem("user")}var e=this.getRouter();e.getRoute("login").attachMatched(this._onRouteMatched,this)},_onRouteMatched:function(){var e=new t;this.getOwnerComponent().setModel(e,"Login");var s=sap.ui.core.UIComponent.getRouterFor(this);var a=[new o("Email","EQ",localStorage.getItem("Email")),new o("Password","EQ",localStorage.getItem("Password"))];if(localStorage.getItem("user")!=undefined){this.openBusyDialog();i.callGETOData(this._oModel,"/UserLogin",a).then(function(e){localStorage.setItem("user",e.results[0].ClientID);localStorage.setItem("Email",e.results[0].Email);localStorage.setItem("Password",e.results[0].Password);this.getView().getParent().getParent().getSideContent().setVisible(true);this.getOwnerComponent()._clientId=e.results[0].ClientID;this._loadOrgChart()}.bind(this)).catch(function(e){this.openMessageBox(JSON.parse(e.responseText).error.message.value);this.closeBusyDialog()}.bind(this))}},onSubmit:function(){let e=["txtUserId","txtPwd"];var t=this.validateEventFeedbackForm(e);if(t===false){return false}var s=this.getView().getModel("Login").getData();var a=sap.ui.core.UIComponent.getRouterFor(this);this.openBusyDialog();var n=[new o("Email","EQ",s.uname),new o("Password","EQ",s.pwd)];i.callGETOData(this._oModel,"/UserLogin",n).then(function(e){localStorage.setItem("user",e.results[0].ClientID);localStorage.setItem("Email",e.results[0].Email);localStorage.setItem("Password",e.results[0].Password);this.getView().getParent().getParent().getSideContent().setVisible(true);this.getOwnerComponent()._clientId=e.results[0].ClientID;this._loadOrgChart()}.bind(this)).catch(function(e){this.openMessageBox(JSON.parse(e.responseText).error.message.value);this.closeBusyDialog()}.bind(this))},_loadPermissions:function(e){let t=[new o("UserID","EQ",e)];let s={$expand:"RoleDettails/RolePermissions"};i.callGETOData(this._oModel,"/UserAssignedRoles",t,s).then(function(e){var t=[];for(let s in e.results){t=e.results[s].RoleDettails.RolePermissions.PermissionByObject;for(let e in t){this.getOwnerComponent().getModel("auth").setProperty("/"+t[e].ObjectID,t[e])}}this.byId("BusyDialog").close()}.bind(this)).catch(function(e){this.openMessageBox(JSON.parse(e.responseText).error.message.value);this.closeBusyDialog()}.bind(this))},_loadOrgChart:function(){this.openBusyDialog();i.callGETOData(this._oModel,"/orgChart('"+this.getOwnerComponent()._clientId+"')").then(function(e){this.getModel("orgChart").setData(e);this.getRouter().navTo("detailsd1");this.closeBusyDialog()}.bind(this)).catch(function(e){this.openMessageBox(JSON.parse(e.responseText).error.message.value);this.closeBusyDialog()}.bind(this))},validateEventFeedbackForm:function(e){var t=this;var s=true;e.forEach(function(e){var o=t.getView().byId(e);if(o.getValue()==""||o.getValue()==undefined){s=false;o.setValueState("Error")}else{o.setValueState("None")}});return s},onNavBack:function(){var e=s.getInstance();var t=e.getPreviousHash();if(t!==undefined&&t!==""){window.history.go(-1)}},onForgetPassword:function(){var e=this.getRouter();e.navTo("Targetforgotpassword")}})});