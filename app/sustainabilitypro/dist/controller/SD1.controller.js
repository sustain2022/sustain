sap.ui.define(["sustainabilitypro/controller/BaseController","sap/ui/model/Filter","../utils/util","sustainabilitypro/controller/oDataHelper"],function(e,t,a,o){"use strict";return e.extend("sustainabilitypro.controller.SD1",{onInit:function(){var e=new sap.ui.model.json.JSONModel({client:"CL0001"});this.getOwnerComponent().setModel(e,"prop");if(localStorage.getItem("user")){this.getOwnerComponent()._clientId=localStorage.getItem("user")}this.getRouter().getRoute("detailsd1").attachPatternMatched(this._onRouteMatched,this);this._readTemplates()},_onRouteMatched:function(e){var n=[new t({path:"ClientID",operator:"EQ",value1:this.getOwnerComponent()._clientId})];this.openBusyDialog();o.callGETOData(this.getModel(),"/GoalHeader/$count",n).then(function(e){this.byId("idGoalTile").getTileContent()[0].getContent().setValue(e);this.closeBusyDialog()}.bind(this)).catch(function(e){this.openMessageBox(JSON.parse(e.responseText).error.message.value);this.closeBusyDialog()}.bind(this));n=[new t({path:"ClientID",operator:"EQ",value1:this.getOwnerComponent()._clientId}),new t({path:"TeamType",operator:"EQ",value1:"Internal"})];this.openBusyDialog();o.callGETOData(this.getModel(),"/TeamHeader/$count",n).then(function(e){this.closeBusyDialog();this.byId("idInternalTeamTile").getTileContent()[0].getContent().setValue(e)}.bind(this)).catch(function(e){this.openMessageBox(JSON.parse(e.responseText).error.message.value);this.closeBusyDialog()});n=[new t({path:"ClientID",operator:"EQ",value1:this.getOwnerComponent()._clientId}),new t({path:"TeamType",operator:"EQ",value1:"External"})];this.openBusyDialog();o.callGETOData(this.getModel(),"/TeamHeader/$count",n).then(function(e){this.closeBusyDialog();this.byId("idExternalTeamTile").getTileContent()[0].getContent().setValue(e)}.bind(this)).catch(function(e){this.openMessageBox(JSON.parse(e.responseText).error.message.value);this.closeBusyDialog()});a.clientFilter(this,"GoalMenu","items");a.clientFilter(this,"idGoalsTable","items")},_readTemplates:function(){var e=[new t({path:"ClientID",operator:"EQ",value1:this.getOwnerComponent()._clientId})];this.openBusyDialog();o.callGETOData(this.getModel(),"/AgencyReportTemplate",e,{$expand:"AgencyReportTemplateDetails"}).then(function(e){this.closeBusyDialog();this._templates=e.results}.bind(this)).catch(function(e){this.openMessageBox(JSON.parse(e.responseText).error.message.value);this.closeBusyDialog()}.bind(this))},openLogout:function(){localStorage.removeItem("user");localStorage.removeItem("Email");localStorage.removeItem("Password");this.getView().getParent().getParent().getSideContent().setVisible(false);var e=sap.ui.core.UIComponent.getRouterFor(this);this.getOwnerComponent().getModel("appProp").setData({});e.navTo("login")},onMenuAction:function(e){this.getOwnerComponent().getRouter().navTo("detailsd2",{templateid:e.getParameter("item").getKey()})},showGoalDetails:function(e){this.getOwnerComponent()._sGoalDetPath=e.getSource().getBindingContext().getPath();var t=e.getSource().getModel().getProperty(e.getSource().getBindingContext().getPath());this.getOwnerComponent().getRouter().navTo("goaldet",{path:t.GoalTemplateID+";"+t.ClientID+";"+t.GoalID})},onTilePress:function(e){var t=e.getSource().getHeader();switch(t){case"Total Goals Created":this.getOwnerComponent().getRouter().navTo("goals");break;case"Internal Teams":this.getOwnerComponent()._setSection="Internal Team";this.getOwnerComponent().getRouter().navTo("teammgmnt");break;case"External Teams":this.getOwnerComponent()._setSection="External Team";this.getOwnerComponent().getRouter().navTo("teammgmnt");break;default:break}},onUploadRequest:function(e){if(!this.uploadDialog){this.uploadDialog=this.loadFragment({name:"sustainabilitypro.fragments.UploadReports"}).then(function(e){this.uploadDialog=e;e.open()}.bind(this))}else{this.uploadDialog.open()}},onSelectingRBG:function(e){if(e.getParameter("selectedIndex")===0){this.byId("idSelectTemplate").setVisible(true);this.byId("dataStartingRow").setVisible(true);this.byId("templateName").setVisible(false)}else{this.byId("idSelectTemplate").setVisible(false);this.byId("dataStartingRow").setVisible(false);this.byId("templateName").setVisible(true)}},onTemplateSelection:function(e){e.getSource().setValueState("None")},onUpload:function(e){this._import(e.getParameter("files")&&e.getParameter("files")[0])},_import:function(e){var t=this;var a={};if(e&&window.FileReader){var o=new FileReader;o.onload=function(e){var o=e.target.result;var n=XLSX.read(o,{type:"binary"});n.SheetNames.forEach(function(e){a=XLSX.utils.sheet_to_row_object_array(n.Sheets[e],{header:1})});t._excelData=a};o.onerror=function(e){console.log(e)};o.readAsBinaryString(e)}},onUploadReport:function(){var e=this.byId("idSelectTemplate").getSelectedKey();if(e==""&&this.byId("rbgUpload").getSelectedIndex()==0){this.byId("idSelectTemplate").setValueState("Error");return}if(this.byId("rbgUpload").getSelectedIndex()==1){this.createTemplate()}else{var t=this.byId("dataStartingRow").getValue();var a=this._templates.map(function(e){return e.TemplateID}).indexOf(e);var o=this._templates[a].AgencyReportTemplateDetails.results;var n=this.getOwnerComponent().getModel();n.setUseBatch(true);n.setDeferredGroups(["foo"]);var i={groupId:"foo",success:function(e,t){sap.m.MessageToast.show("Uploaded");this._setReports=true;this._onRouteMatched()}.bind(this),error:function(){}};for(var s in this._excelData){if(s<t){continue}var l={TemplateID:e,ClientID:this.getOwnerComponent()._clientId};var r=[];for(var g in o){var p={TemplateID:e,ClientID:this.getOwnerComponent()._clientId,FieldID:o[g].FieldID,FieldValue:this._excelData[s][o[g].FieldSRN-1].toString()};r.push(p)}l.AgencyReportDetails=r;n.create("/AgencyReportHeader",l,i)}}this.uploadDialog.close()},createTemplate:function(){var e=[];var t=this.getOwnerComponent().getModel();var a=this.getOwnerComponent().getModel("goals");t.setUseBatch(true);t.setDeferredGroups(["foo"]);var o={groupId:"foo",success:function(e,t){sap.m.MessageToast.show("Template Created")}.bind(this),error:function(e,t){sap.m.MessageToast.show("Template Creation Failed")}.bind(this)};var n={ClientID:this.getOwnerComponent()._clientId,TemplateName:this.byId("templateName").getValue(),TemplateDescription:this.byId("templateName").getValue()};var i=this._excelData[0];for(var s in i){var l={ClientID:this.getOwnerComponent()._clientId,FieldID:parseInt(s)+1,FieldSRN:parseInt(s)+1,FieldName:i[s],FieldDescription:i[s]};e.push(l)}n.AgencyReportTemplateDetails=e;t.create("/AgencyReportTemplate",n,o)},onCloseUploadDlg:function(){this.uploadDialog.close()},handleGoalFilter:function(){if(!this.goalFilterDialog){this.goalFilterDialog=this.loadFragment({name:"sustainabilitypro.fragments.GoalFilter"}).then(function(e){this.goalFilterDialog=e;e.open()}.bind(this))}else{this.goalFilterDialog.open()}},handleFilterConfirm:function(e){var t=this.byId("idGoalsTable").getBinding("items"),a;if(e.getParameter("filterCompoundKeys")[1]){var o=Object.keys(e.getParameter("filterCompoundKeys")[1]);for(var n in o){if(n==0){a="DepartmentAssignment/any(d:d/DepartmentID eq '"+o[n]+"')"}else{a=a+" or DepartmentAssignment/any(d:d/DepartmentID eq '"+o[n]+"')"}}t.sFilterParams=t.sFilterParams+" and ("+a+")";t.refresh()}else{t.sFilterParams="$filter=ClientID eq '"+this.getOwnerComponent()._clientId+"'";t.refresh()}}})});