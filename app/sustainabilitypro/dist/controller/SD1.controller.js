sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/Filter","../utils/util"],function(e,t,a){"use strict";return e.extend("susproapp.controller.SD1",{onInit:function(){var e=new sap.ui.model.json.JSONModel({client:"CL0001"});this.getOwnerComponent().setModel(e,"prop");if(localStorage.getItem("user")){this.getOwnerComponent()._clientId=localStorage.getItem("user")}this.getOwnerComponent().getRouter().getRoute("detailsd1").attachPatternMatched(this._onRouteMatched,this);this._readTemplates()},_onRouteMatched:function(e){this.getView().getModel().read("/GoalHeader/$count",{filters:[new sap.ui.model.Filter({path:"ClientID",operator:"EQ",value1:this.getOwnerComponent()._clientId})],success:function(e){this.byId("idGoalTile").getTileContent()[0].getContent().setValue(e)}.bind(this)});this.getView().getModel().read("/TeamHeader/$count",{filters:[new sap.ui.model.Filter({path:"ClientID",operator:"EQ",value1:this.getOwnerComponent()._clientId}),new sap.ui.model.Filter({path:"TeamType",operator:"EQ",value1:"Internal"})],success:function(e){this.byId("idInternalTeamTile").getTileContent()[0].getContent().setValue(e)}.bind(this)});this.getView().getModel().read("/TeamHeader/$count",{filters:[new sap.ui.model.Filter({path:"ClientID",operator:"EQ",value1:this.getOwnerComponent()._clientId}),new sap.ui.model.Filter({path:"TeamType",operator:"EQ",value1:"External"})],success:function(e){this.byId("idExternalTeamTile").getTileContent()[0].getContent().setValue(e)}.bind(this)});a.clientFilter(this,"GoalMenu","items");a.clientFilter(this,"idGoalsTable","items")},_readTemplates:function(){this.getOwnerComponent().getModel().read("/AgencyReportTemplate",{filters:[new sap.ui.model.Filter({path:"ClientID",operator:"EQ",value1:this.getOwnerComponent()._clientId})],urlParameters:{$expand:"AgencyReportTemplateDetails"},success:function(e){this._templates=e.results}.bind(this)})},openLogout:function(){localStorage.removeItem("user");localStorage.removeItem("Email");localStorage.removeItem("Password");this.getView().getParent().getParent().getSideContent().setVisible(false);var e=sap.ui.core.UIComponent.getRouterFor(this);this.getOwnerComponent().getModel("appProp").setData({});e.navTo("login")},onMenuAction:function(e){this.getOwnerComponent().getRouter().navTo("detailsd2",{templateid:e.getParameter("item").getKey()})},showGoalDetails:function(e){this.getOwnerComponent()._sGoalDetPath=e.getSource().getBindingContext().getPath();var t=e.getSource().getModel().getProperty(e.getSource().getBindingContext().getPath());this.getOwnerComponent().getRouter().navTo("goaldet",{path:t.GoalTemplateID+";"+t.ClientID+";"+t.GoalID})},onTilePress:function(e){var t=e.getSource().getHeader();switch(t){case"Total Goals Created":this.getOwnerComponent().getRouter().navTo("goals");break;case"Internal Teams":this.getOwnerComponent()._setSection="Internal Team";this.getOwnerComponent().getRouter().navTo("teammgmnt");break;case"External Teams":this.getOwnerComponent()._setSection="External Team";this.getOwnerComponent().getRouter().navTo("teammgmnt");break;default:break}},onUploadRequest:function(e){if(!this.uploadDialog){this.uploadDialog=this.loadFragment({name:"sustainabilitypro.fragments.UploadReports"}).then(function(e){this.uploadDialog=e;e.open()}.bind(this))}else{this.uploadDialog.open()}},onSelectingRBG:function(e){if(e.getParameter("selectedIndex")===0){this.byId("idSelectTemplate").setVisible(true);this.byId("dataStartingRow").setVisible(true);this.byId("templateName").setVisible(false)}else{this.byId("idSelectTemplate").setVisible(false);this.byId("dataStartingRow").setVisible(false);this.byId("templateName").setVisible(true)}},onTemplateSelection:function(e){e.getSource().setValueState("None")},onUpload:function(e){this._import(e.getParameter("files")&&e.getParameter("files")[0])},_import:function(e){var t=this;var a={};if(e&&window.FileReader){var n=new FileReader;n.onload=function(e){var n=e.target.result;var i=XLSX.read(n,{type:"binary"});i.SheetNames.forEach(function(e){a=XLSX.utils.sheet_to_row_object_array(i.Sheets[e],{header:1})});t._excelData=a};n.onerror=function(e){console.log(e)};n.readAsBinaryString(e)}},onUploadReport:function(){var e=this.byId("idSelectTemplate").getSelectedKey();if(e==""&&this.byId("rbgUpload").getSelectedIndex()==0){this.byId("idSelectTemplate").setValueState("Error");return}if(this.byId("rbgUpload").getSelectedIndex()==1){this.createTemplate()}else{var t=this.byId("dataStartingRow").getValue();var a=this._templates.map(function(e){return e.TemplateID}).indexOf(e);var n=this._templates[a].AgencyReportTemplateDetails.results;var i=this.getOwnerComponent().getModel();i.setUseBatch(true);i.setDeferredGroups(["foo"]);var o={groupId:"foo",success:function(e,t){sap.m.MessageToast.show("Uploaded");this._setReports=true;this._onRouteMatched()}.bind(this),error:function(){}};for(var r in this._excelData){if(r<t){continue}var s={TemplateID:e,ClientID:this.getOwnerComponent()._clientId};var l=[];for(var d in n){var p={TemplateID:e,ClientID:this.getOwnerComponent()._clientId,FieldID:n[d].FieldID,FieldValue:this._excelData[r][n[d].FieldSRN-1].toString()};l.push(p)}s.AgencyReportDetails=l;i.create("/AgencyReportHeader",s,o)}i.submitChanges(o)}this.uploadDialog.close()},createTemplate:function(){var e=[];var t=this.getOwnerComponent().getModel();var a=this.getOwnerComponent().getModel("goals");t.setUseBatch(true);t.setDeferredGroups(["foo"]);var n={groupId:"foo",success:function(e,t){sap.m.MessageToast.show("Template Created")}.bind(this),error:function(e,t){sap.m.MessageToast.show("Template Creation Failed")}.bind(this)};var i={ClientID:this.getOwnerComponent()._clientId,TemplateName:this.byId("templateName").getValue(),TemplateDescription:this.byId("templateName").getValue()};var o=this._excelData[0];for(var r in o){var s={ClientID:this.getOwnerComponent()._clientId,FieldID:parseInt(r)+1,FieldSRN:parseInt(r)+1,FieldName:o[r],FieldDescription:o[r]};e.push(s)}i.AgencyReportTemplateDetails=e;t.create("/AgencyReportTemplate",i,n);t.submitChanges(n)},onCloseUploadDlg:function(){this.uploadDialog.close()},handleGoalFilter:function(){if(!this.goalFilterDialog){this.goalFilterDialog=this.loadFragment({name:"sustainabilitypro.fragments.GoalFilter"}).then(function(e){this.goalFilterDialog=e;e.open()}.bind(this))}else{this.goalFilterDialog.open()}},handleFilterConfirm:function(e){var t=this.byId("idGoalsTable").getBinding("items"),a;if(e.getParameter("filterCompoundKeys")[1]){var n=Object.keys(e.getParameter("filterCompoundKeys")[1]);for(var i in n){if(i==0){a="DepartmentAssignment/any(d:d/DepartmentID eq '"+n[i]+"')"}else{a=a+" or DepartmentAssignment/any(d:d/DepartmentID eq '"+n[i]+"')"}}t.sFilterParams=t.sFilterParams+" and ("+a+")";t.refresh()}else{t.sFilterParams="$filter=ClientID eq '"+this.getOwnerComponent()._clientId+"'";t.refresh()}}})});