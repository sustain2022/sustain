sap.ui.define(["sustainabilitypro/controller/BaseController","sap/m/Input","sap/m/TextArea","sap/m/DatePicker","sap/ui/layout/form/FormElement","sap/ui/core/Fragment","sap/ui/model/Filter","../utils/util","sustainabilitypro/controller/oDataHelper"],function(e,t,a,i,s,o,l,n,r){"use strict";return e.extend("susproapp.controller.SD2",{onInit:function(){if(localStorage.getItem("user")){this.getOwnerComponent()._clientId=localStorage.getItem("user")}this.getRouter().getRoute("detailsd2").attachPatternMatched(this._onRouteMatched,this);this._formFragments={};this._showFormFragment("/Change")},_onRouteMatched:function(e){this._templateid=e.getParameter("arguments").templateid;var t=[new l({path:"GoalTemplateID",operator:"EQ",value1:this._templateid}),new l({path:"ClientID",operator:"EQ",value1:this.getOwnerComponent()._clientId})];this.openBusyDialog();r.callGETOData(this.getModel(),"/GoaTemplateFields",t).then(function(e){this.closeBusyDialog();this._aFields=e.results;this._generateFields(e.results)}.bind(this)).catch(function(e){this.openMessageBox(JSON.parse(e.responseText).error.message.value);this.closeBusyDialog()}.bind(this))},_generateFields:function(e){var t=this.byId("FormGoal").getFormContainers()[0];t.destroyFormElements();e.sort(function(e,t){return e.FieldSRN-t.FieldSRN});for(var a in e){t.addFormElement(new s({label:e[a].FieldName,fields:[n.getEditField(e[a])]}))}t.addFormElement(new s({label:"Impact Category",fields:[new sap.m.Select({items:[new sap.ui.core.Item({key:"Environmental",text:"Environmental"}),new sap.ui.core.Item({key:"Social",text:"Social"}),new sap.ui.core.Item({key:"Economical",text:"Economical"})],customData:[new sap.ui.core.CustomData({key:"FldId",value:"IC"}),new sap.ui.core.CustomData({key:"FldName",value:"Impact Category"})]})]}))},onBeforeRendering:function(e){},onNavPress:function(){this._toggleButtonsAndView(true);this.getRouter().navTo("detailsd1")},onSaveSubmit:function(e){if(e.getSource().getText()=="Save"){this._onSave()}else{this._onSubmit()}},_onSave:function(){var e=[];var t=this.getModel();var a=this.getModel("goals");t.setDeferredGroups(["foo"]);var i={groupId:"foo",success:function(e,t){var a=new sap.ui.layout.form.FormElement({label:"{GoalFields/FieldName}",fields:[new sap.m.Text({text:"{FieldValue}"})]});if(e.GoalID!=undefined){this._savedGoal=e;this.byId("FormDisplay354").getFormContainers()[0].destroyFormElements();this.byId("FormDisplay354").getFormContainers()[0].addFormElement(new sap.ui.layout.form.FormElement({label:"Goal Name",fields:[new sap.m.Text({text:e.GoalName})]}));this.byId("FormDisplay354").getFormContainers()[0].addFormElement(new sap.ui.layout.form.FormElement({label:"Visibility",fields:[new sap.m.Text({text:e.Visibility})]}));this.byId("FormDisplay354").getFormContainers()[0].addFormElement(new sap.ui.layout.form.FormElement({label:"Impact Category",fields:[new sap.m.Text({text:e.ImpactCategory})]}));this.byId("FormDisplay354").getFormContainers()[0].addFormElement(new sap.ui.layout.form.FormElement({label:"Metric",fields:[new sap.m.Text({text:e.Metric})]}));this.byId("FormDisplay354").getFormContainers()[0].addFormElement(new sap.ui.layout.form.FormElement({label:"Begin Date",fields:[new sap.m.Text({text:e.BeginDate})]}));this.byId("FormDisplay354").getFormContainers()[0].addFormElement(new sap.ui.layout.form.FormElement({label:"End Date",fields:[new sap.m.Text({text:e.EndDate})]}));this.byId("FormDisplay354").getFormContainers()[1].destroyFormElements();this.byId("FormDisplay354").getFormContainers()[1].bindAggregation("formElements",{path:"/GoalHeader(GoalTemplateID='"+e.GoalTemplateID+"',ClientID='"+e.ClientID+"',GoalID="+parseInt(e.GoalID)+")/GoalDetails",parameters:{expand:"GoalFields"},template:a})}sap.m.MessageToast.show("Goal Saved")}.bind(this),error:function(e){var t=new sap.ui.layout.form.FormElement({label:"{GoalFields/FieldName}",fields:[new sap.m.Text({text:"{FieldValue}"})]});this.openMessageBox(JSON.parse(e.responseText).error.message.value)}.bind(this)};var s={GoalTemplateID:this._templateid,ClientID:this.getOwnerComponent()._clientId};s.GoalStatus_Sys="1";var o=this.byId("FormGoal").getFormContainers()[0].getFormElements();for(var l in o){var n=o[l].getFields()[0].getCustomData()[0].getValue();var r=o[l].getFields()[0].getCustomData()[1].getValue();if(r=="Visibility"){s.Visibility=this._getFieldValue(o[l].getFields()[0])}else if(r=="Goal Name"){s.GoalName=this._getFieldValue(o[l].getFields()[0])}else if(r=="Status"){s.GoalStaus_Biz=this._getFieldValue(o[l].getFields()[0])}else if(r=="Metric"){s.Metric=this._getFieldValue(o[l].getFields()[0])}else if(r=="%Complete"){s.GoalCompletion=this._getFieldValue(o[l].getFields()[0])}else if(r=="Begin date"){s.BeginDate=this._getFieldValue(o[l].getFields()[0])}else if(r=="End Date"){s.EndDate=this._getFieldValue(o[l].getFields()[0])}else if(r=="Impact Category"){s.ImpactCategory=this._getFieldValue(o[l].getFields()[0])}else{var m={GoalTemplateID:this._templateid,ClientID:this.getOwnerComponent()._clientId,FieldID:n,FieldValue:this._getFieldValue(o[l].getFields()[0])};e.push(m)}}s.GoalDetails=e;a.setProperty("/displayFields",s);t.create("/GoalHeader",s,i);t.submitChanges();this._toggleButtonsAndView(false)},_onSubmit:function(){var e=this.getModel();e.setDeferredGroups(["foo"]);var t={groupId:"foo",success:function(e,t){this.getOwnerComponent().getRouter().navTo("detailsd1");sap.m.MessageToast.show("Goal Submitted")}.bind(this),error:function(e){sap.m.MessageToast.show("Goal Submit Failed")}.bind(this)};e.update("/GoalHeader(GoalTemplateID='"+this._savedGoal.GoalTemplateID+"',ClientID='"+this._savedGoal.ClientID+"',GoalID="+parseInt(this._savedGoal.GoalID)+")",{GoalStatus_Sys:"2"},t);e.submitChanges(t)},_getFieldValue:function(e){var t=e.getMetadata().getName();switch(t){case"sap.m.Select":return e.getSelectedItem().getText();break;case"sap.m.Input":return e.getValue();break;case"sap.m.TextArea":return e.getValue();break;case"sap.m.DatePicker":return e.getDateValue();break;default:break}},handleEditPress:function(){this._toggleButtonsAndView(true)},handleCancelPress:function(){this.getRouter().navTo("detailsd1")},_toggleButtonsAndView:function(e){var t=this.getView();t.byId("edit").setVisible(!e);t.byId("save").setVisible(e);t.byId("submit").setVisible(!e);t.byId("cancel").setVisible(e);this._showFormFragment(e?"/Change":"/Display")},_getFormFragment:function(e){var t=this._formFragments[e],a=this.getView();if(!t){t=o.load({id:a.getId(),name:"sustainabilitypro.fragments."+e});this._formFragments[e]=t}return t},_showFormFragment:function(e){var t=this.byId("sd2fragments");t.removeAllContent();this._getFormFragment(e).then(function(e){t.insertContent(e)})}})});